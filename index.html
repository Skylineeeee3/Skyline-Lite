<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline Lite | v2.0</title>
    <!-- Lucide Icons for the modern look -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #0a0b14;
            --surface: #161827;
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.3);
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --ai-bubble: #1e2136;
            --user-bubble: #4f46e5;
            --code-bg: #0d0e1a;
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            padding: 20px;
        }

        /* Unified App Container */
        .app-container {
            width: 100%;
            max-width: 900px;
            height: 100%;
            max-height: 850px;
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Header Styling inside block */
        header {
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            color: var(--primary);
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        header h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Chat Area */
        #chat {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        #chat::-webkit-scrollbar {
            width: 5px;
        }
        #chat::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .msg-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-wrapper { align-self: flex-end; }
        .ai-wrapper { align-self: flex-start; }

        .bubble {
            padding: 10px 16px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 0.9rem;
            position: relative;
            word-wrap: break-word;
        }

        .user-bubble {
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-bubble {
            background: var(--ai-bubble);
            color: var(--text-main);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Markdown Styles within Bubble */
        .bubble h1, .bubble h2, .bubble h3 { margin: 8px 0; font-size: 1.1em; color: var(--primary); }
        .bubble p { margin: 8px 0; }
        .bubble ul, .bubble ol { padding-left: 20px; margin: 8px 0; }
        .bubble strong { color: white; }

        /* Code Block Styling */
        .code-block-container {
            margin: 10px 0;
            background: var(--code-bg);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            font-family: 'Fira Code', monospace;
        }

        .code-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-lang {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            border-radius: 4px;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        pre {
            margin: 0;
            padding: 12px;
            overflow-x: auto;
            font-size: 0.8rem;
            color: #d1d5db;
        }

        /* Footer Container */
        .input-wrapper {
            padding: 1.25rem;
            background: rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .file-chip {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--primary);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-main);
        }

        .remove-file {
            cursor: pointer;
            color: var(--text-muted);
        }

        .remove-file:hover { color: #ff4b4b; }

        .input-container {
            background: #1e2136;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            display: flex;
            align-items: center;
            padding: 4px 6px;
        }

        .input-container:focus-within {
            border-color: var(--primary);
            background: #232742;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .action-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            padding: 8px 10px;
            font-size: 0.95rem;
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .typing-dot {
            height: 6px;
            width: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="logo-container">
            <i data-lucide="zap" class="logo-icon" size="20"></i>
            <h1>Skyline Lite</h1>
        </div>
        <div id="key-status" style="color: var(--text-muted); font-size: 0.75rem;">PROGRAMMING AI</div>
    </header>

    <div id="chat">
        <div class="msg-wrapper ai-wrapper">
            <div class="bubble ai-bubble">
                Hello! I am Skyline Lite. How can I help you today?
            </div>
        </div>
    </div>

    <div class="input-wrapper">
        <div id="file-preview-area" class="attachment-preview"></div>
        <div class="input-container">
            <input type="file" id="file-input" style="display: none;" multiple onchange="handleFileSelect(event)">
            <button class="action-btn" onclick="document.getElementById('file-input').click()">
                <i data-lucide="paperclip" size="18"></i>
            </button>
            <input id="input" placeholder="Ask me anything..." autocomplete="off" />
            <button class="send-btn" onclick="send()">
                <i data-lucide="arrow-up" size="18"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Array of API keys for rotation
const API_KEYS = [
  
    "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",
    "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",
    "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",
    "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",
    "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"
];

let currentKeyIndex = 0;
const MODEL = "mistralai/devstral-2512:free";

let memory = [
    {
        role: "system",
        content: "You are Skyline Lite. You are fast, lightweight, helpful, concise, and friendly. You explain things clearly. If you provide code, wrap it in markdown code blocks like ```python ... ```. You can analyze files provided by the user."
    }
];

let attachedFiles = [];

lucide.createIcons();

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            attachedFiles.push({
                name: file.name,
                type: file.type,
                content: e.target.result
            });
            renderFileChips();
        };
        
        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    });
    event.target.value = '';
}

function renderFileChips() {
    const area = document.getElementById('file-preview-area');
    area.innerHTML = attachedFiles.map((f, i) => `
        <div class="file-chip">
            <i data-lucide="file-text" size="12"></i>
            <span>${f.name}</span>
            <i data-lucide="x" size="12" class="remove-file" onclick="removeFile(${i})"></i>
        </div>
    `).join('');
    lucide.createIcons();
}

function removeFile(index) {
    attachedFiles.splice(index, 1);
    renderFileChips();
}

function parseMarkdown(text) {
    let html = text
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^\* (.*$)/gm, '<li>$1</li>')
        .replace(/^- (.*$)/gm, '<li>$1</li>');
    
    if (html.includes('<li>')) {
        html = html.replace(/(<li>.*<\/li>)+/g, '<ul>$&</ul>');
    }
    
    return html.replace(/\n/g, '<br>');
}

function formatAIResponse(text) {
    if (!text) return "";
    
    const regex = /```(\w+)?\n([\s\S]*?)```/g;
    let lastIndex = 0;
    const parts = [];
    let match;

    while ((match = regex.exec(text)) !== null) {
        if (match.index > lastIndex) {
            parts.push({ type: 'text', content: text.substring(lastIndex, match.index) });
        }
        parts.push({ 
            type: 'code', 
            lang: match[1] || 'code', 
            content: match[2].trim() 
        });
        lastIndex = regex.lastIndex;
    }
    
    if (lastIndex < text.length) {
        parts.push({ type: 'text', content: text.substring(lastIndex) });
    }

    if (parts.length === 0) return `<div>${parseMarkdown(text)}</div>`;

    return parts.map(part => {
        if (part.type === 'text') return `<div>${parseMarkdown(part.content)}</div>`;
        
        const safeId = 'code-' + Math.random().toString(36).substr(2, 9);
        return `
            <div class="code-block-container">
                <div class="code-header">
                    <span class="code-lang">${part.lang}</span>
                    <button class="copy-btn" onclick="copyCode('${safeId}')">
                        <i data-lucide="copy" style="width: 12px; height: 12px;"></i>
                        <span id="label-${safeId}">Copy</span>
                    </button>
                </div>
                <pre id="${safeId}">${part.content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            </div>
        `;
    }).join('');
}

function copyCode(id) {
    const code = document.getElementById(id).innerText;
    const textArea = document.createElement("textarea");
    textArea.value = code;
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        const label = document.getElementById('label-' + id);
        label.innerText = 'Copied!';
        setTimeout(() => label.innerText = 'Copy', 2000);
    } catch (err) {
        console.error('Copy failed', err);
    }
    document.body.removeChild(textArea);
}

function addMessage(text, type, isAI = false) {
    const chat = document.getElementById("chat");
    const wrapper = document.createElement("div");
    wrapper.className = `msg-wrapper ${type}-wrapper`;
    
    const bubble = document.createElement("div");
    bubble.className = `bubble ${type}-bubble`;
    
    if (isAI && type === 'ai') {
        bubble.innerHTML = formatAIResponse(text);
    } else {
        bubble.textContent = text;
    }
    
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
    
    lucide.createIcons();
    return wrapper;
}

async function send() {
    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text && attachedFiles.length === 0) return;

    input.value = "";
    
    let displayMsg = text;
    let fullPrompt = text;
    
    if (attachedFiles.length > 0) {
        let fileContext = attachedFiles.map(f => {
            if (f.type.startsWith('image/')) {
                return `[Image Attached: ${f.name}]`;
            } else {
                return `[File Attached: ${f.name}]\nContent:\n${f.content}\n---`;
            }
        }).join('\n');
        fullPrompt = `${fileContext}\n\nUser Question: ${text}`;
        displayMsg = (attachedFiles.length > 0 ? `ðŸ“Ž ${attachedFiles.length} file(s) attached\n` : "") + text;
    }

    addMessage(displayMsg, "user");
    memory.push({ role: "user", content: fullPrompt });
    attachedFiles = [];
    renderFileChips();

    const thinking = addMessage("", "ai");
    thinking.querySelector('.bubble').innerHTML = `
        <div style="display: flex; gap: 4px; padding: 4px 0;">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;

    // Attempt to call API with rotation logic
    const attemptRequest = async (keyIdx) => {
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + API_KEYS[keyIdx],
                    "Content-Type": "application/json",
                    "HTTP-Referer": "http://localhost",
                    "X-Title": "Skyline Lite"
                },
                body: JSON.stringify({
                    model: MODEL,
                    messages: memory
                })
            });

            if (res.status === 429 || res.status === 401) {
                // Rate limit or Auth error: try next key
                if (keyIdx + 1 < API_KEYS.length) {
                    currentKeyIndex = keyIdx + 1;
                    document.getElementById('key-status').textContent = `SWITCHING KEY (${currentKeyIndex + 1}/${API_KEYS.length})`;
                    return await attemptRequest(currentKeyIndex);
                }
            }

            return res;
        } catch (err) {
            if (keyIdx + 1 < API_KEYS.length) {
                currentKeyIndex = keyIdx + 1;
                return await attemptRequest(currentKeyIndex);
            }
            throw err;
        }
    };

    try {
        const res = await attemptRequest(currentKeyIndex);
        const data = await res.json();
        thinking.remove();

        if (data.choices && data.choices[0] && data.choices[0].message) {
            const reply = data.choices[0].message.content;
            addMessage(reply, "ai", true);
            memory.push({ role: "assistant", content: reply });
            document.getElementById('key-status').textContent = "PROGRAMMING AI";
        } else {
            addMessage("Received an empty or invalid response from the AI service.", "ai");
        }

    } catch (err) {
        thinking.remove();
        console.error("Fetch Error:", err);
        addMessage("All API keys failed or connection error occurred.", "ai");
    }
}

document.getElementById("input").addEventListener("keydown", e => {
    if (e.key === "Enter") send();
});
</script>

</body>
</html>

